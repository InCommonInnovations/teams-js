import{__awaiter as e}from"../../../../node_modules/tslib/tslib.es6.js";import{sendMessageToParent as r}from"../internal/communication.js";import{registerHandler as i}from"../internal/handlers.js";import{ensureInitialized as o}from"../internal/internalAPIs.js";import{getApiVersionTag as t}from"../internal/telemetry.js";import{inServerSideRenderingEnvironment as n}from"../internal/utils.js";import{createEffectParameterChangeCallback as d,processMediaStreamWithMetadata as s,processMediaStream as a}from"../internal/videoEffectsUtils.js";import{VideoPerformanceMonitor as f}from"../internal/videoPerformanceMonitor.js";import{errorNotSupportedOnPlatform as m,FrameContexts as c}from"../public/constants.js";import{runtime as l}from"../public/runtime.js";import{videoEffects as v}from"../public/videoEffects.js";const u="v2";var E;!function(E){E.frameProcessingTimeoutInMs=2e3;const p=n()?void 0:new f(r);let F;function g(){const e=setTimeout((()=>{P(`Frame not processed in ${E.frameProcessingTimeoutInMs}ms`,F.Warn)}),E.frameProcessingTimeoutInMs);return function(){clearTimeout(e)}}function h(){return o(l),v.isSupported()}function P(e,i=F.Warn){r(t(u,"videoEffectsEx.notifyError"),"video.notifyError",[e,i])}!function(e){e.Fatal="fatal",e.Warn="warn"}(F=E.ErrorLevel||(E.ErrorLevel={})),E.registerForVideoFrame=function(n){var d,f;if(!h())throw m;if(!n.videoFrameHandler||!n.videoBufferHandler)throw new Error("Both videoFrameHandler and videoBufferHandler must be provided");if(o(l,c.sidePanel)){if(i(t(u,"videoEffectsEX.registerSetFrameProcessTimeLimitHandler"),"video.setFrameProcessTimeLimit",(e=>null==p?void 0:p.setFrameProcessTimeLimit(e)),!1),null===(d=l.supports.video)||void 0===d?void 0:d.mediaStream)i(t(u,"videoEffectsEX.registerStartVideoExtensibilityVideoStreamHandler"),"video.startVideoExtensibilityVideoStream",(r=>e(this,void 0,void 0,(function*(){const{streamId:i,metadataInTexture:o}=r,t=p?function(r,i){return o=>e(this,void 0,void 0,(function*(){const e=o.videoFrame;i.reportStartFrameProcessing(e.codedWidth,e.codedHeight);const t=g(),n=yield r(o);return t(),i.reportFrameProcessed(),n}))}(n.videoFrameHandler,p):n.videoFrameHandler;o?yield s(i,t,P,p):yield a(i,t,P,p)}))),!1),r(t(u,"videoEffectsEX.mediaStream.registerForVideoFrame"),"video.mediaStream.registerForVideoFrame",[n.config]);else{if(!(null===(f=l.supports.video)||void 0===f?void 0:f.sharedFrame))throw m;i(t(u,"videoEffectsEx.registerNewVideoFrameHandler"),"video.newVideoFrame",(e=>{if(e){null==p||p.reportStartFrameProcessing(e.width,e.height);const i=g(),o=e.timestamp;n.videoBufferHandler(function(e){return e.videoFrameBuffer=e.videoFrameBuffer||e.data,delete e.data,e}(e),(()=>{i(),null==p||p.reportFrameProcessed(),function(e){r(t(u,"videoEffectsEx.notifyVideoFrameProcessed"),"video.videoFrameProcessed",[e])}(o)}),P)}}),!1),r(t(u,"videoEffectsEx.registerForVideoFrame"),"video.registerForVideoFrame",[n.config])}null==p||p.startMonitorSlowFrameProcessing()}},E.notifySelectedVideoEffectChanged=function(e,i,n){if(o(l,c.sidePanel),!h())throw m;r(t(u,"videoEffectsEx.notifySelectedVideoEffectChanged"),"video.videoEffectChanged",[e,i,n])},E.registerForVideoEffect=function(e){if(o(l,c.sidePanel),!h())throw m;i(t(u,"videoEffectsEx.registerEffectParamterChangeHandler"),"video.effectParameterChange",d(e,p),!1),r(t(u,"videoEffectsEx.registerForVideoEffect"),"video.registerForVideoEffect")},E.updatePersonalizedEffects=function(e){if(o(l,c.sidePanel),!v.isSupported())throw m;r(t(u,"videoEffectsEx.updatePersonalizedEffects"),"video.personalizedEffectsChanged",[e])},E.isSupported=h,E.notifyFatalError=function(e){if(o(l),!v.isSupported())throw m;P(e,F.Fatal)}}(E||(E={}));export{E as videoEffectsEx};
