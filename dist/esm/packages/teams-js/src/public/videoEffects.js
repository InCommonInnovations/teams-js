import{__awaiter as e,__rest as i}from"../../../../node_modules/tslib/tslib.es6.js";import{sendMessageToParent as r}from"../internal/communication.js";import{registerHandler as o}from"../internal/handlers.js";import{ensureInitialized as t}from"../internal/internalAPIs.js";import{getApiVersionTag as n}from"../internal/telemetry.js";import{ssrSafeWindow as d,inServerSideRenderingEnvironment as a}from"../internal/utils.js";import{createEffectParameterChangeCallback as f,processMediaStream as s}from"../internal/videoEffectsUtils.js";import{VideoPerformanceMonitor as m}from"../internal/videoPerformanceMonitor.js";import{FrameContexts as c,errorNotSupportedOnPlatform as l}from"./constants.js";import{runtime as v}from"./runtime.js";const u="v2";var F;!function(F){const E=a()?void 0:new m(r);var p,g;function h(e){r(n(u,"videoEffects.notifyError"),"video.notifyError",[e])}function P(){return t(v)&&!!v.supports.video&&(!!v.supports.video.mediaStream||!!v.supports.video.sharedFrame)}function V(){var e;return t(v,c.sidePanel)&&function(){var e,i,r,o;return!(!(null===(i=null===(e=d().chrome)||void 0===e?void 0:e.webview)||void 0===i?void 0:i.getTextureStream)||!(null===(o=null===(r=d().chrome)||void 0===r?void 0:r.webview)||void 0===o?void 0:o.registerTextureStream))}()&&!!(null===(e=v.supports.video)||void 0===e?void 0:e.mediaStream)}function w(){var e;return t(v,c.sidePanel)&&!!(null===(e=v.supports.video)||void 0===e?void 0:e.sharedFrame)}(F.VideoFrameFormat||(F.VideoFrameFormat={})).NV12="NV12",(p=F.EffectChangeType||(F.EffectChangeType={})).EffectChanged="EffectChanged",p.EffectDisabled="EffectDisabled",(g=F.EffectFailureReason||(F.EffectFailureReason={})).InvalidEffectId="InvalidEffectId",g.InitializationFailure="InitializationFailure",F.registerForVideoFrame=function(d){if(t(v,c.sidePanel),!P())throw l;if(!d.videoFrameHandler||!d.videoBufferHandler)throw new Error("Both videoFrameHandler and videoBufferHandler must be provided");if(o(n(u,"videoEffects.setFrameProcessTimeLimitHandler"),"video.setFrameProcessTimeLimit",(e=>null==E?void 0:E.setFrameProcessTimeLimit(e.timeLimit)),!1),V())!function(i,d){if(t(v,c.sidePanel),!P()||!V())throw l;o(n(u,"videoEffects.startVideoExtensibilityVideoStreamHandler"),"video.startVideoExtensibilityVideoStream",(r=>e(this,void 0,void 0,(function*(){const{streamId:o}=r,t=function(i,r){return o=>e(this,void 0,void 0,(function*(){const e=o.videoFrame;null==r||r.reportStartFrameProcessing(e.codedWidth,e.codedHeight);const t=yield i(o);return null==r||r.reportFrameProcessed(),t}))}(i,E);yield s(o,t,h,E)}))),!1),r(n(u,"videoEffects.mediaStream.registerForVideoFrame"),"video.mediaStream.registerForVideoFrame",[d])}(d.videoFrameHandler,d.config);else{if(!w())throw l;!function(e,d){if(t(v,c.sidePanel),!P()||!w())throw l;o(n(u,"videoEffects.registerForVideoBufferHandler"),"video.newVideoFrame",(o=>{if(o){const t=o.timestamp;null==E||E.reportStartFrameProcessing(o.width,o.height),e(function(e){if("videoFrameBuffer"in e)return e;{const{data:r}=e,o=i(e,["data"]);return Object.assign(Object.assign({},o),{videoFrameBuffer:r})}}(o),(()=>{null==E||E.reportFrameProcessed(),function(e){r(n(u,"videoEffects.notifyVideoFrameProcessed"),"video.videoFrameProcessed",[e])}(t)}),h)}}),!1),r(n(u,"videoEffects.registerForVideoFrame"),"video.registerForVideoFrame",[d])}(d.videoBufferHandler,d.config)}null==E||E.startMonitorSlowFrameProcessing()},F.notifySelectedVideoEffectChanged=function(e,i){if(t(v,c.sidePanel),!P())throw l;r(n(u,"videoEffects.notifySelectedVideoEffectChanged"),"video.videoEffectChanged",[e,i])},F.registerForVideoEffect=function(e){if(t(v,c.sidePanel),!P())throw l;o(n(u,"videoEffects.registerEffectParameterChangeHandler"),"video.effectParameterChange",f(e,E),!1),r(n(u,"videoEffects.registerForVideoEffect"),"video.registerForVideoEffect")},F.isSupported=P}(F||(F={}));export{F as videoEffects};
