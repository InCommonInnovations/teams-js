import{sendMessageToParent as e,sendAndHandleSdkError as t}from"../internal/communication.js";import{captureImageMobileSupportVersion as i,mediaAPISupportVersion as o,getMediaCallbackSupportVersion as r,nonFullScreenVideoModeAPISupportVersion as n,scanBarCodeAPIMobileSupportVersion as a}from"../internal/constants.js";import{GlobalVars as s}from"../internal/globalVars.js";import{registerHandler as l,removeHandler as m}from"../internal/handlers.js";import{ensureInitialized as d,isCurrentSDKVersionAtLeast as c,throwExceptionIfMobileApiIsNotSupported as u}from"../internal/internalAPIs.js";import{validateGetMediaInputs as h,throwExceptionIfMediaCallIsNotSupportedOnMobile as p,validateSelectMediaInputs as f,isVideoControllerRegistered as C,validateViewImagesInput as M,validateScanBarCodeInput as g,createFile as T,decodeAttachment as b}from"../internal/mediaUtil.js";import{getLogger as v,getApiVersionTag as y}from"../internal/telemetry.js";import{isNullOrUndefined as R}from"../internal/typeCheckUtilities.js";import{generateGUID as k}from"../internal/utils.js";import{FrameContexts as w,errorNotSupportedOnPlatform as A,HostClientType as I}from"./constants.js";import{ErrorCode as E,DevicePermission as P}from"./interfaces.js";import{runtime as O}from"./runtime.js";const S="v1",L=v("media");var D;!function(v){var D;(D=v.FileFormat||(v.FileFormat={})).Base64="base64",D.ID="id";class F{}function N(){return!(!d(O)||!O.supports.permissions)}v.File=F,v.captureImage=function(t){if(!t)throw new Error("[captureImage] Callback cannot be null");if(d(O,w.content,w.task),s.isFramelessWindow)if(c(i))e(y(S,"media.captureImage"),"captureImage",t);else{t({errorCode:E.OLD_PLATFORM},[])}else{t({errorCode:E.NOT_SUPPORTED_ON_PLATFORM},[])}},v.hasPermission=function(){if(d(O,w.content,w.task),!N())throw A;const e=P.Media;return new Promise((i=>{i(t(y(S,"media.hasPermission"),"permissions.has",e))}))},v.requestPermission=function(){if(d(O,w.content,w.task),!N())throw A;const e=P.Media;return new Promise((i=>{i(t(y(S,"media.requestPermission"),"permissions.request",e))}))};class _ extends F{constructor(e){super(),e&&(this.content=e.content,this.format=e.format,this.mimeType=e.mimeType,this.name=e.name,this.preview=e.preview,this.size=e.size)}getMedia(e){if(!e)throw new Error("[get Media] Callback cannot be null");if(d(O,w.content,w.task),c(o))if(h(this.mimeType,this.format,this.content))c(r)?this.getMediaViaCallback(e):this.getMediaViaHandler(e);else{e({errorCode:E.INVALID_ARGUMENTS},new Blob)}else{e({errorCode:E.OLD_PLATFORM},new Blob)}}getMediaViaCallback(t){const i={mediaMimeType:this.mimeType,assembleAttachment:[]},o=[this.content];e(y(S,"media.getMedia"),"getMedia",o,(function(e){if(t)if(e&&e.error)t(e.error,new Blob);else if(e&&e.mediaChunk)if(e.mediaChunk.chunkSequence<=0){const o=T(i.assembleAttachment,i.mediaMimeType);t(e.error,null!=o?o:new Blob)}else{const t=b(e.mediaChunk,i.mediaMimeType);t?i.assembleAttachment.push(t):L(`Received a null assemble attachment for when decoding chunk sequence ${e.mediaChunk.chunkSequence}; not including the chunk in the assembled file.`)}else t({errorCode:E.INTERNAL_ERROR,message:"data received is null"},new Blob)}))}getMediaViaHandler(t){const i=k(),o={mediaMimeType:this.mimeType,assembleAttachment:[]},r=[i,this.content];this.content&&!R(t)&&e(y(S,"media.getMedia"),"getMedia",r),l(y(S,"media.registerGetMediaRequestHandler"),"getMedia"+i,(function(e){if(t){const r=JSON.parse(e);if(r.error)t(r.error,new Blob),m("getMedia"+i);else if(r.mediaChunk)if(r.mediaChunk.chunkSequence<=0){const e=T(o.assembleAttachment,o.mediaMimeType);t(r.error,null!=e?e:new Blob),m("getMedia"+i)}else{const e=b(r.mediaChunk,o.mediaMimeType);e&&o.assembleAttachment.push(e)}else t({errorCode:E.INTERNAL_ERROR,message:"data received is null"},new Blob),m("getMedia"+i)}}))}}v.Media=_;class B{constructor(e){this.controllerCallback=e}notifyEventToHost(t,i){d(O,w.content,w.task);try{u(n)}catch(e){return void(i&&i(e))}const o={mediaType:this.getMediaType(),mediaControllerEvent:t};e(y(S,"media.controller"),"media.controller",[o],(e=>{i&&i(e)}))}stop(e){this.notifyEventToHost(V.StopRecording,e)}}let V;var j,U;let G;var q,H;v.VideoController=class extends B{getMediaType(){return G.Video}notifyEventToApp(e){if(this.controllerCallback)switch(e){case V.StartRecording:if(this.controllerCallback.onRecordingStarted){this.controllerCallback.onRecordingStarted();break}}}},function(e){e[e.StartRecording=1]="StartRecording",e[e.StopRecording=2]="StopRecording"}(V=v.MediaControllerEvent||(v.MediaControllerEvent={})),(j=v.CameraStartMode||(v.CameraStartMode={}))[j.Photo=1]="Photo",j[j.Document=2]="Document",j[j.Whiteboard=3]="Whiteboard",j[j.BusinessCard=4]="BusinessCard",(U=v.Source||(v.Source={}))[U.Camera=1]="Camera",U[U.Gallery=2]="Gallery",function(e){e[e.Image=1]="Image",e[e.Video=2]="Video",e[e.VideoAndImage=3]="VideoAndImage",e[e.Audio=4]="Audio"}(G=v.MediaType||(v.MediaType={})),(q=v.ImageUriType||(v.ImageUriType={}))[q.ID=1]="ID",q[q.URL=2]="URL",(H=v.ImageOutputFormats||(v.ImageOutputFormats={}))[H.IMAGE=1]="IMAGE",H[H.PDF=2]="PDF",v.selectMedia=function(t,i){if(!i)throw new Error("[select Media] Callback cannot be null");if(d(O,w.content,w.task),!c(o)){const e={errorCode:E.OLD_PLATFORM};return void i(e,[])}try{p(t)}catch(e){return void i(e,[])}if(!f(t)){const e={errorCode:E.INVALID_ARGUMENTS};return void i(e,[])}const r=[t];e(y(S,"media.selectMedia"),"selectMedia",r,((e,o,r)=>{var n,a;if(r)return void(C(t)&&(null===(a=null===(n=null==t?void 0:t.videoProps)||void 0===n?void 0:n.videoController)||void 0===a||a.notifyEventToApp(r)));if(!o)return void i(e,[]);const s=[];for(const e of o)s.push(new _(e));i(e,s)}))},v.viewImages=function(t,i){if(!i)throw new Error("[view images] Callback cannot be null");if(d(O,w.content,w.task),!c(o)){return void i({errorCode:E.OLD_PLATFORM})}if(!M(t)){return void i({errorCode:E.INVALID_ARGUMENTS})}const r=[t];e(y(S,"media.viewImages"),"viewImages",r,i)},v.scanBarCode=function(t,i){if(!t)throw new Error("[media.scanBarCode] Callback cannot be null");if(d(O,w.content,w.task),s.hostClientType!==I.desktop&&s.hostClientType!==I.web&&s.hostClientType!==I.rigel&&s.hostClientType!==I.teamsRoomsWindows&&s.hostClientType!==I.teamsRoomsAndroid&&s.hostClientType!==I.teamsPhones&&s.hostClientType!==I.teamsDisplays)if(c(a))if(g(i))e(y(S,"media.scanBarCode"),"media.scanBarCode",[i],t);else{t({errorCode:E.INVALID_ARGUMENTS},"")}else{t({errorCode:E.OLD_PLATFORM},"")}else{t({errorCode:E.NOT_SUPPORTED_ON_PLATFORM},"")}}}(D||(D={}));export{D as media};
